{% extends 'base.html' %}
{% block content %}
<div class="container my-5">
  <h2 class="fw-bold text-center mb-4">DETAIL GROUND CHECK</h2>

  <!-- Info Umum -->
  <div class="mb-4">
    <p><strong>Lokasi:</strong> {{ record.lokasi }}</p>
    <p><strong>Tanggal:</strong> {{ record.tanggal.strftime('%d-%m-%Y') }}</p>
    <p><strong>Teknisi:</strong> {{ record.teknisi }}</p>
    <p><strong>Catatan:</strong> {{ record.catatan }}</p>
  </div>

  <!-- Tabel Data -->
  <div class="table-responsive">
    <table class="table table-bordered text-center align-middle">
      <thead class="table-light">
        <tr>
          <th rowspan="2">FREQ</th>
          <th rowspan="2">JARAK (M)</th>
          <th rowspan="2">DEGREE (°)</th>
          <th colspan="6">TX 1</th>
          <th colspan="6">TX 2</th>
        </tr>
        <tr>
          <th>DDM (%)</th><th>DDM (µA)</th><th>SUM (%)</th>
          <th>MOD 90 Hz</th><th>MOD 150 Hz</th><th>RF LEVEL (dB)</th>
          <th>DDM (%)</th><th>DDM (µA)</th><th>SUM (%)</th>
          <th>MOD 90 Hz</th><th>MOD 150 Hz</th><th>RF LEVEL (dB)</th>
        </tr>
      </thead>
      <tbody>
        {% set data_90hz = rows | selectattr("freq","equalto","90 Hz") | list %}
        {% set data_center = rows | selectattr("freq","equalto","Center") | list %}
        {% set data_150hz = rows | selectattr("freq","equalto","150 Hz") | list %}

        <!-- 90 Hz -->
        {% for row in data_90hz %}
        <tr>
          {% if loop.first %}<td rowspan="{{ data_90hz|length }}">90 Hz</td>{% endif %}
          <td>{{ row.jarak }}</td>
          <td>{{ row.degree }}</td>
          <td>{{ row.tx1_ddm_persen or '' }}</td>
          <td>{{ row.tx1_ddm_ua or '' }}</td>
          <td>{{ row.tx1_sum or '' }}</td>
          <td>{{ row.tx1_mod90 or '' }}</td>
          <td>{{ row.tx1_mod150 or '' }}</td>
          <td>{{ row.tx1_rf or '' }}</td>
          <td>{{ row.tx2_ddm_persen or '' }}</td>
          <td>{{ row.tx2_ddm_ua or '' }}</td>
          <td>{{ row.tx2_sum or '' }}</td>
          <td>{{ row.tx2_mod90 or '' }}</td>
          <td>{{ row.tx2_mod150 or '' }}</td>
          <td>{{ row.tx2_rf or '' }}</td>
        </tr>
        {% endfor %}

        <!-- Center -->
        {% for row in data_center %}
        <tr>
          <td></td>
          <td>{{ row.jarak }}</td>
          <td>{{ row.degree }}</td>
          <td>{{ row.tx1_ddm_persen or '' }}</td>
          <td>{{ row.tx1_ddm_ua or '' }}</td>
          <td>{{ row.tx1_sum or '' }}</td>
          <td>{{ row.tx1_mod90 or '' }}</td>
          <td>{{ row.tx1_mod150 or '' }}</td>
          <td>{{ row.tx1_rf or '' }}</td>
          <td>{{ row.tx2_ddm_persen or '' }}</td>
          <td>{{ row.tx2_ddm_ua or '' }}</td>
          <td>{{ row.tx2_sum or '' }}</td>
          <td>{{ row.tx2_mod90 or '' }}</td>
          <td>{{ row.tx2_mod150 or '' }}</td>
          <td>{{ row.tx2_rf or '' }}</td>
        </tr>
        {% endfor %}

        <!-- 150 Hz -->
        {% for row in data_150hz %}
        <tr>
          {% if loop.first %}<td rowspan="{{ data_150hz|length }}">150 Hz</td>{% endif %}
          <td>{{ row.jarak }}</td>
          <td>{{ row.degree }}</td>
          <td>{{ row.tx1_ddm_persen or '' }}</td>
          <td>{{ row.tx1_ddm_ua or '' }}</td>
          <td>{{ row.tx1_sum or '' }}</td>
          <td>{{ row.tx1_mod90 or '' }}</td>
          <td>{{ row.tx1_mod150 or '' }}</td>
          <td>{{ row.tx1_rf or '' }}</td>
          <td>{{ row.tx2_ddm_persen or '' }}</td>
          <td>{{ row.tx2_ddm_ua or '' }}</td>
          <td>{{ row.tx2_sum or '' }}</td>
          <td>{{ row.tx2_mod90 or '' }}</td>
          <td>{{ row.tx2_mod150 or '' }}</td>
          <td>{{ row.tx2_rf or '' }}</td>
        </tr>
         {% endfor %}
    </table>






  <!-- ==================== GRAFIK ==================== -->
  <div class="container mt-4">
  <h4 class="mt-3">Grafik Ground Check</h4>

  <!-- Normal -->
  <canvas id="chartTx1Normal" class="mt-4"></canvas>
  <canvas id="chartTx2Normal" class="mt-4"></canvas>

  <!-- Mirror -->
  <canvas id="chartTx1Mirror" class="mt-4"></canvas>
  <canvas id="chartTx2Mirror" class="mt-4"></canvas>
</div>
</div> 
<div class="mt-4">
    <a href="{{ url_for('groundcheck.lihat_data') }}" class="btn btn-secondary">Kembali</a>
  </div> 
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // === DATA DARI FLASK ===
    let degrees = [35,30,25,20,15,10,5,1.85,0,1.85,5,10,15,20,25,30,35];
    let tx1 = JSON.parse('{{ rows|map(attribute="tx1_ddm_persen")|list|tojson|safe }}');
    let tx2 = JSON.parse('{{ rows|map(attribute="tx2_ddm_persen")|list|tojson|safe }}');

    let chartInstances = {};

    // === BUAT DATA MIRROR ===
    function makeMirror(rawData) {
        let left  = [...rawData].slice(0,8);
        let right = [...rawData].slice(8);
        let rawMirror = left.concat(right);
        let plotMirror = rawMirror.map(v => Math.abs(v));
        return { rawMirror, plotMirror };
    }
    let tx1Mirror = makeMirror(tx1);
    let tx2Mirror = makeMirror(tx2);
    let degreesMirror = [...degrees];

    // === FUNGSI RENDER GRAFIK ===
    function renderChart(canvasId, label, rawData, plotData, labels, color) {
        if (chartInstances[canvasId]) {
            chartInstances[canvasId].destroy();
        }

        chartInstances[canvasId] = new Chart(document.getElementById(canvasId).getContext('2d'), {
            type: 'line',
            data: {
                labels: labels.map(d => d+"°"),
                datasets: [{
                    label: label,
                    data: plotData,
                    borderColor: color,
                    backgroundColor: color.replace('1)', '0.1)'),
                    pointBackgroundColor: color,
                    pointRadius: 4,
                    tension: 0.2,
                    rawValues: rawData
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: label + ' Ground Performance Curve',
                        font: { size: 18, weight: 'bold' },
                        padding: { top: 10, bottom: 20 }
                    },
                    datalabels: {
                        color: 'black',
                        align: 'top',
                        font: { weight: 'bold' },
                        formatter: (value, ctx) => {
                            let raw = ctx.dataset.rawValues[ctx.dataIndex];
                            return raw !== null ? raw.toFixed(2) : '';
                        }
                    },
                    annotation: {
                        annotations: {
                            verticalLine: {
                                type: 'line',
                                xMin: labels.indexOf(0),
                                xMax: labels.indexOf(0),
                                borderColor: 'black',
                                borderWidth: 2
                            },
                            horizontalLine: {
                                type: 'line',
                                yMin: 0,
                                yMax: 0,
                                borderColor: 'black',
                                borderWidth: 2
                            }
                        }
                    }
                },
                scales: {
                    x: { title: { display: true, text: 'Degree (°)' } },
                    y: { title: { display: true, text: 'DDM (%)' } }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    // === RENDER SEMUA GRAFIK ===
    // Normal
    renderChart('chartTx1Normal', 'TX1 Normal', tx1, tx1, degrees, 'rgba(0,0,255,1)');
    renderChart('chartTx2Normal', 'TX2 Normal', tx2, tx2, degrees, 'rgba(255,0,0,1)');

    // Mirror
    renderChart('chartTx1Mirror', 'TX1 Mirror', tx1Mirror.rawMirror, tx1Mirror.plotMirror, degreesMirror, 'rgba(0,0,255,1)');
    renderChart('chartTx2Mirror', 'TX2 Mirror', tx2Mirror.rawMirror, tx2Mirror.plotMirror, degreesMirror, 'rgba(255,0,0,1)');
});
</script>
<footer class="text-center text-muted py-3 small bg-white border-top mt-auto">
    {% block footer %}{% endblock %}
    &copy; {{ current_year or '2025' }} - AirNav Surabaya
  </footer>
{% endblock %}

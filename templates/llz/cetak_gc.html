{% extends "base.html" %}
{% block content %}
<div class="container my-4" id="print-area">
  <!-- Header -->
  <div class="text-center mb-4">
    <img src="{{ url_for('static', filename='img/airnav_logo.png') }}" alt="AirNav Logo" style="height:80px; margin-bottom:15px;">
    <h5 class="fw-bold">PERUM LPPNPI - KANTOR CABANG {{ record.lokasi|upper }}</h5>
    <h4 class="fw-bold">GROUND CHECK LOCALIZER PERFORMANCE CURVE</h4>
  </div>

  <!-- Info Umum -->
  <div class="row mb-4">
    <div class="col-md-6">
      <p><strong>Tanggal:</strong> {{ record.tanggal.strftime('%d-%m-%Y') }}</p>
      <p><strong>Fasilitas:</strong> Instrument Landing System</p>
      <p><strong>Merk:</strong> Normarc 7000B</p>
      <p><strong>Ident-Freq:</strong> ISBR - 110.10 MHz</p>
    </div>
  </div>

  <!-- ================= TABEL DATA ================= -->
  <div class="table-responsive">
    <table class="table table-bordered text-center align-middle">
      <thead class="table-secondary">
        <tr>
          <th rowspan="2">FREQ</th>
          <th rowspan="2">JARAK (M)</th>
          <th rowspan="2">DEGREE (¬∞)</th>
          <th colspan="6">TX 1</th>
          <th colspan="6">TX 2</th>
        </tr>
        <tr>
          <th>DDM (%)</th><th>DDM (¬µA)</th><th>SUM (%)</th>
          <th>MOD 90 Hz</th><th>MOD 150 Hz</th><th>RF LEVEL (dB)</th>
          <th>DDM (%)</th><th>DDM (¬µA)</th><th>SUM (%)</th>
          <th>MOD 90 Hz</th><th>MOD 150 Hz</th><th>RF LEVEL (dB)</th>
        </tr>
      </thead>
      <tbody>
        {% set data_90hz = rows | selectattr("freq","equalto","90 Hz") | list %}
        {% set data_center = rows | selectattr("freq","equalto","Center") | list %}
        {% set data_150hz = rows | selectattr("freq","equalto","150 Hz") | list %}

        <!-- 90 Hz -->
        {% for row in data_90hz %}
        <tr>
          {% if loop.first %}<td rowspan="{{ data_90hz|length }}">90 Hz</td>{% endif %}
          <td>{{ row.jarak }}</td>
          <td>{{ row.degree }}</td>
          <td>{{ row.tx1_ddm_persen or '' }}</td>
          <td>{{ row.tx1_ddm_ua or '' }}</td>
          <td>{{ row.tx1_sum or '' }}</td>
          <td>{{ row.tx1_mod90 or '' }}</td>
          <td>{{ row.tx1_mod150 or '' }}</td>
          <td>{{ row.tx1_rf or '' }}</td>
          <td>{{ row.tx2_ddm_persen or '' }}</td>
          <td>{{ row.tx2_ddm_ua or '' }}</td>
          <td>{{ row.tx2_sum or '' }}</td>
          <td>{{ row.tx2_mod90 or '' }}</td>
          <td>{{ row.tx2_mod150 or '' }}</td>
          <td>{{ row.tx2_rf or '' }}</td>
        </tr>
        {% endfor %}

        <!-- Center -->
        {% for row in data_center %}
        <tr>
          {% if loop.first %}<td rowspan="{{ data_center|length }}"></td>{% endif %}
          <td>{{ row.jarak }}</td>
          <td>{{ row.degree }}</td>
          <td>{{ row.tx1_ddm_persen or '' }}</td>
          <td>{{ row.tx1_ddm_ua or '' }}</td>
          <td>{{ row.tx1_sum or '' }}</td>
          <td>{{ row.tx1_mod90 or '' }}</td>
          <td>{{ row.tx1_mod150 or '' }}</td>
          <td>{{ row.tx1_rf or '' }}</td>
          <td>{{ row.tx2_ddm_persen or '' }}</td>
          <td>{{ row.tx2_ddm_ua or '' }}</td>
          <td>{{ row.tx2_sum or '' }}</td>
          <td>{{ row.tx2_mod90 or '' }}</td>
          <td>{{ row.tx2_mod150 or '' }}</td>
          <td>{{ row.tx2_rf or '' }}</td>
        </tr>
        {% endfor %}

        <!-- 150 Hz -->
        {% for row in data_150hz %}
        <tr>
          {% if loop.first %}<td rowspan="{{ data_150hz|length }}">150 Hz</td>{% endif %}
          <td>{{ row.jarak }}</td>
          <td>{{ row.degree }}</td>
          <td>{{ row.tx1_ddm_persen or '' }}</td>
          <td>{{ row.tx1_ddm_ua or '' }}</td>
          <td>{{ row.tx1_sum or '' }}</td>
          <td>{{ row.tx1_mod90 or '' }}</td>
          <td>{{ row.tx1_mod150 or '' }}</td>
          <td>{{ row.tx1_rf or '' }}</td>
          <td>{{ row.tx2_ddm_persen or '' }}</td>
          <td>{{ row.tx2_ddm_ua or '' }}</td>
          <td>{{ row.tx2_sum or '' }}</td>
          <td>{{ row.tx2_mod90 or '' }}</td>
          <td>{{ row.tx2_mod150 or '' }}</td>
          <td>{{ row.tx2_rf or '' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- ==================== PAGE BREAK ==================== -->
  <div class="page-break"></div>

  <!-- ==================== GRAFIK (4 buah) ==================== -->
  <div class="row mt-4">
    <div class="col-md-6 mb-4"><canvas id="chartTx1Normal"></canvas></div>
    <div class="col-md-6 mb-4"><canvas id="chartTx1Mirror"></canvas></div>
    <div class="col-md-6 mb-4"><canvas id="chartTx2Normal"></canvas></div>
    <div class="col-md-6 mb-4"><canvas id="chartTx2Mirror"></canvas></div>
  </div>

  <!-- ==================== TEKNISI & PARAF ==================== -->
  <div class="row mt-4">
    <div class="col-12">
      <table class="table table-bordered align-middle" style="width:100%;">
        <tr>
          <td style="width:60%;">
            <strong>Teknisi On Duty :</strong>
            <ol style="margin-top:10px; margin-bottom:10px;">
              {% for t in record.teknisi.split(',') %}
                <li>{{ t.strip() }}</li>
              {% endfor %}
            </ol>
          </td>
          <td style="width:40%;">
            <strong>Paraf :</strong>
            <ol style="margin-top:10px; margin-bottom:10px; list-style-position: inside;">
              {% for t in record.teknisi.split(',') %}
                <li>&nbsp;</li>
              {% endfor %}
            </ol>
          </td>
        </tr>
      </table>
    </div>
  </div>

  <!-- ==================== MANAGER TEKNIK ==================== -->
  <div class="row mt-5">
    <div class="col-12 text-center">
      <p><strong>MANAGER TEKNIK</strong></p>
      <br><br><br>
      <p><u>{{ record.manager }}</u></p>
    </div>
  </div>

  <!-- Tombol Print -->
  <div class="text-center mb-5 no-print">
    <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Cetak</button>
  </div>
</div>

<!-- Script Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    let degrees = {{ rows|map(attribute="degree")|list|tojson }};
    let tx1 = {{ rows|map(attribute="tx1_ddm_persen")|list|tojson }};
    let tx2 = {{ rows|map(attribute="tx2_ddm_persen")|list|tojson }};

    function renderChart(canvasId, label, rawData, labels, color, mirror=false) {
        let data = mirror ? rawData.map(v => v !== null ? -v : null) : rawData;

        new Chart(document.getElementById(canvasId), {
            type: 'line',
            data: {
                labels: labels.map(d => d+"¬∞"),
                datasets: [{
                    label: label,
                    data: data,
                    borderColor: color,
                    backgroundColor: color.replace('1)', '0.1)'),
                    pointBackgroundColor: color,
                    pointRadius: 3,
                    tension: 0.2
                }]
            },
            options: {
                responsive: true,
                devicePixelRatio: 3,
                plugins: {
                    title: {
                        display: true,
                        text: label + (mirror ? " (Mirror)" : " (Normal)"),
                        font: { size: 14, weight: 'bold' }
                    },
                    datalabels: {
                        color: 'black',
                        align: 'top',
                        font: { weight: 'bold' },
                        formatter: (value) => value !== null ? value.toFixed(2) : ''
                    }
                },
                scales: {
                    x: { title: { display: true, text: 'Degree (¬∞)' } },
                    y: { title: { display: true, text: 'DDM (%)' } }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    renderChart('chartTx1Normal', 'TX1', tx1, degrees, 'rgba(0,0,255,1)', false);
    renderChart('chartTx1Mirror', 'TX1', tx1, degrees, 'rgba(0,0,255,1)', true);
    renderChart('chartTx2Normal', 'TX2', tx2, degrees, 'rgba(255,0,0,1)', false);
    renderChart('chartTx2Mirror', 'TX2', tx2, degrees, 'rgba(255,0,0,1)', true);
});
</script>

<style>
.page-break {
  page-break-before: always;
}

@media print {
  @page {
    size: A4 landscape;
    margin: 15mm;
  }

  body * {
    visibility: hidden;
  }

  #print-area, #print-area * {
    visibility: visible;
  }

  #print-area {
    margin: 0;
    padding: 0;
  }

  .no-print {
    display: none !important;
  }

  table {
    font-size: 11px;
    page-break-inside: avoid;
  }

  .row {
    page-break-inside: avoid;
  }

  canvas {
    max-width: 100% !important;
    height: auto !important;
    page-break-inside: avoid;
  }
}
</style>
{% endblock %}
{% block footer %}{% endblock %}
